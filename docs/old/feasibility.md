# 実現可能性の検証

## 1. 検証の目的

要件を満たすために、技術・運用の両面で実現可能かを整理する。

## 2. 検証結果サマリ

| 項目 | 実現可能性 | リスク・条件 |
|------|------------|----------------|
| 毎月23日22時のトリガー | ◎ 可能 | スケジューラの用意が必要 |
| 月2枠の制御 | ◎ 可能 | アプリ側で「2件まで」と制限すればよい |
| 予約サイトの自動操作 | △ 要確認 | ログイン・CAPTCHA・構造変更の可能性 |
| 条件に合う日付の予約 | ◎ 可能 | 条件フォーマットとスクレイピング/操作の設計次第 |
| 条件指定の方法 | ◎ 可能 | 設定ファイル or スプレッドシート等で実現可 |
| 忘れないようにする | ◎ 可能 | リマインダー（Slack/カレンダー等）で対応可 |
| 中1週を空ける | ◎ 可能 | 日付フィルタのロジックで実装可 |

---

## 3. 項目別の検証

### 3.1 毎月23日22時から予約可能になる（R1）

- **実現性**: ◎ 実現可能
- **方法**:
  - **cron**: `0 22 23 * *` で月1回、23日22時にジョブ実行
  - **Google Apps Script**: Time-driven trigger で「毎月23日 22:00」に実行
  - **GitHub Actions / Cloud Scheduler**: 同様に日時指定で実行
- **注意**: 実行環境のタイムゾーンを日本時間（JST）に合わせる必要あり。

### 3.2 月に2枠まで（R2）

- **実現性**: ◎ 実現可能
- **方法**: 予約処理ロジック内で「今月の予約数が2未満なら予約する」と制限する。サイト側も2枠制限がある想定なので、アプリ側で2件で打ち切ればよい。

### 3.3 予約サイトの自動操作（R3, R4）

- **実現性**: △ 要確認（サイト次第）
- **確認したこと**:
  - `calendar.php` はマイページのため、未ログインでは内容取得できず（404やログイン画面に飛ぶ想定）。
  - 実際のHTML構造・フォーム・ボタンはログイン後に確認する必要あり。
- **想定リスク**:
  1. **ログイン**: ID/パスワードまたはCookieが必要。二要素認証があると自動化が困難になる可能性。
  2. **CAPTCHA**: ログインや予約確定時にCAPTCHAが出る場合、完全自動は難しくなる（手動対応 or サービス利用の検討）。
  3. **サイト構造変更**: デザイン変更でセレクタが変わるとスクリプト修正が必要。
  4. **利用規約**: 自動アクセスが規約違反でないか要確認。
- **推奨**: 一度ブラウザでログインし、カレンダー・予約ボタン・日付の選び方などを手動で確認してから、操作手順とセレクタを設計する。

### 3.4 条件に合う日付の指定と予約（R4, R6）

- **実現性**: ◎ ロジック上は可能
- **条件の指定例**（案）:
  - 「第1週」「第2週」「第3週」「第4週」「最終週」のいずれか
  - 「月・水・金」など曜日指定
  - 「中1週は除外する」をフラグで指定（R6）
- **中1週を空ける**:
  - 月の日付を 1–10 日頃 / 11–20 日頃 / 21–月末 のように分け、真ん中ブロックを「中1週」として除外するフィルタを実装すればよい。
  - 空き枠が中1週にしかない場合は、希望に「中1週OK」を許容するか、予約しないかをポリシーで決める必要あり。

### 3.5 条件の指定方法と忘れないようにする（R5）

- **実現性**: ◎ 可能
- **指定方法の案**:
  - **YAML/JSONの設定ファイル**: リポジトリ内に `config.yml` などで「今月の希望週・曜日・中1週除外」を記述。
  - **Googleスプレッドシート**: 1行で「対象月・希望週・曜日・中1週除外」を管理し、GASで読み込む。
  - **Slack / メール**: 「今月の希望を返信」で受け取り、簡易パースで条件を取得（実装コストはやや高め）。
- **忘れないようにする**:
  - 毎月22日（または23日直前）に「明日22時から翌月予約開始。希望条件の入力をお願いします」と Slack / メール / カレンダーでリマインダー。
  - 23日22時実行時に「今月の条件が未設定」なら通知だけして予約はスキップ、もしくは前月の条件を流用するオプションも可能。

---

## 4. 技術スタックの候補

| 方式 | メリット | デメリット |
|------|----------|------------|
| **Puppeteer / Playwright（Node）** | ブラウザ操作に強い、ローカル・サーバー両方 | ヘッドレス環境の用意、CAPTCHAは未対応 |
| **Selenium（Python）** | 情報が多い、Pythonで書ける | 環境構築・ブラウザドライバの管理 |
| **GAS + UrlFetch / 手動補助** | トリガーで23日22時実行が簡単、スプレッドシート連携しやすい | ブラウザのDOM操作は不可。サイトがAPIを提供していないと完全自動は難しい |
| **GAS + ブラウザ拡張 / 手動実行** | 「ボタン1つで予約」は作りやすい | 完全無人自動は難しい |

**結論**: サイトがログイン＋画面操作のみで予約できるなら、**Playwright または Puppeteer** で「23日22時に実行するジョブ」を組む方式が現実的。GASは「リマインダー」「条件の入力（スプレッドシート）」「23日22時トリガー」に向き、実際の予約クリックはローカル or クラウドのブラウザ自動化に任せる形もあり。

---

## 5. 次のアクション（推奨）

1. **サイトの手動確認**
   - ブラウザでログインし、翌月のカレンダー表示〜予約クリックまでの流れを記録する（URL遷移、ボタン・リンクの位置、日付の選び方）。
2. **利用規約の確認**
   - 自動アクセス・スクリプト利用が禁止されていないか確認する。
3. **条件フォーマットの確定**
   - 「第○週の○曜日」「中1週除外」をどう書くか、1案に決めて設定ファイル or スプレッドシートの項目を設計する。
4. **プロトタイプ**
   - ログイン〜カレンダー表示までを Playwright 等で試し、セレクタと手順が安定するか確認する。
5. **リマインダー**
   - 毎月22日にリマインダーを送る仕組み（Slack Incoming Webhook / カレンダー / メール）を用意する。

以上を踏まえ、**要件はおおむね実現可能**。ただし予約サイトのログイン方式・CAPTCHA・規約の確認が必須で、そこがクリアであれば自動予約の実装は進められる。
